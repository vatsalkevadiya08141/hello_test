name: Auto Deploy to Servers on Tag Release

on:
  push:
    tags:
      - 'v*'           # Trigger on version tags like v1.0.0, v2.1.3, etc.
      - 'release-*'    # Or tags like release-1.0, release-2.0
  workflow_dispatch:   # Allow manual trigger from GitHub UI

jobs:
  notify-servers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history to get tag info
      
      - name: Get tag information
        id: tag-info
        run: |
          # Get the tag name
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # Get tag message/annotation if it exists
          TAG_MESSAGE=$(git tag -l --format='%(contents)' $TAG_NAME)
          if [ -z "$TAG_MESSAGE" ]; then
            TAG_MESSAGE="Release $TAG_NAME"
          fi
          echo "tag_message=$TAG_MESSAGE" >> $GITHUB_OUTPUT
          
          # Get the commit SHA that the tag points to
          TAG_COMMIT=$(git rev-list -n 1 $TAG_NAME)
          echo "tag_commit=$TAG_COMMIT" >> $GITHUB_OUTPUT
          
          # Get changed files between this tag and previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags ${TAG_NAME}^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGED_FILES=$(git diff --name-only $PREVIOUS_TAG $TAG_NAME | tr '\n' ',' | sed 's/,$//')
          else
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $TAG_COMMIT | tr '\n' ',' | sed 's/,$//')
          fi
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install websockets aiohttp
      
      - name: Send deployment notification
        env:
          WEBSOCKET_URL: ${{ secrets.WEBSOCKET_URL }}
          TAG_NAME: ${{ steps.tag-info.outputs.tag_name }}
          TAG_MESSAGE: ${{ steps.tag-info.outputs.tag_message }}
          TAG_COMMIT: ${{ steps.tag-info.outputs.tag_commit }}
          PREVIOUS_TAG: ${{ steps.tag-info.outputs.previous_tag }}
          REPOSITORY: ${{ github.repository }}
          AUTHOR: ${{ github.actor }}
          CHANGED_FILES: ${{ steps.tag-info.outputs.changed_files }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO_URL: ${{ github.repositoryUrl }}
        run: |
          python - <<EOF
          import asyncio
          import websockets
          import json
          import os
          import sys

          async def notify_deployment():
              websocket_url = os.environ.get('WEBSOCKET_URL', 'ws://161.97.92.202:8766')
              
              deployment_data = {
                  'type': 'GITHUB_TAG_RELEASE',
                  'repository': os.environ.get('REPOSITORY', ''),
                  'tag_name': os.environ.get('TAG_NAME', ''),
                  'tag_message': os.environ.get('TAG_MESSAGE', ''),
                  'commit_sha': os.environ.get('TAG_COMMIT', ''),
                  'previous_tag': os.environ.get('PREVIOUS_TAG', ''),
                  'author': os.environ.get('AUTHOR', ''),
                  'changed_files': os.environ.get('CHANGED_FILES', ''),
                  'timestamp': os.environ.get('TIMESTAMP', ''),
                  'repo_url': os.environ.get('REPO_URL', '')
              }
              
              try:
                  print(f"ðŸ·ï¸  Deploying tag: {deployment_data['tag_name']}")
                  print(f"ðŸ“¦ Repository: {deployment_data['repository']}")
                  print(f"ðŸ‘¤ Author: {deployment_data['author']}")
                  print(f"ðŸ“ Message: {deployment_data['tag_message']}")
                  print(f"ðŸ”„ Changed files: {deployment_data['changed_files']}")
                  
                  async with websockets.connect(websocket_url, ping_interval=30) as websocket:
                      # Send GITHUB tag to identify as deployment notification
                      await websocket.send("GITHUB:DEPLOY_NOTIFICATION")
                      print(f"âœ… Sent identification tag")
                      
                      # Send deployment data
                      message = json.dumps(deployment_data)
                      await websocket.send(message)
                      print(f"âœ… Sent deployment notification")
                      
                      # Wait for acknowledgment
                      response = await asyncio.wait_for(websocket.recv(), timeout=10)
                      print(f"âœ… Received response: {response}")
                      
                      return True
              except asyncio.TimeoutError:
                  print("âŒ Timeout waiting for server response")
                  return False
              except Exception as e:
                  print(f"âŒ Error sending notification: {e}")
                  return False

          if __name__ == "__main__":
              result = asyncio.run(notify_deployment())
              sys.exit(0 if result else 1)
          EOF
      
      - name: Deployment status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… Tag deployment notification sent successfully"
            echo "ðŸ·ï¸  Tag: ${{ steps.tag-info.outputs.tag_name }}"
            echo "ðŸ“¦ Servers will now pull and update to this tag"
          else
            echo "âš ï¸ Failed to send deployment notification"
            echo "Please check server logs and retry if needed"
          fi
